"use strict";function _readOnlyError(name){throw new TypeError('"'+name+'" is read-only')}$(document).ready(function(){xalarm.initialize()});var xalarm=new function(){this.originalFavicon=false;this.flashInterval=false;this.gettingAlarms=false;this.initialize=function(){rcmail.addEventListener("plugin.show_alarms",function(data){xalarm.show(data)});if(rcmail.env.user_id!==undefined&&!$("body").hasClass("iframe")){xalarm.getAlarms(true);setInterval(function(){xalarm.getAlarms(false)},6e4)}};this.show=function(data){var alarmDialog=$("#xcalendar-alarm-dialog");if(!alarmDialog.length){alarmDialog=$("<div>").attr("id","xcalendar-alarm-dialog").appendTo("body")}for(var key in data.list){if(data.list.hasOwnProperty(key)){if(!$("#xevent-alarm-"+key).length){alarmDialog.append(data.list[key])}}}alarmDialog.dialog({modal:true,autoOpen:false,resizable:false,closeOnEscape:true,title:rcmail.gettext("upcoming_events","xcalendar"),close:function close(){xalarm.restoreWindow();alarmDialog.html("")},buttons:[{text:rcmail.gettext("dismiss_all","xcalendar"),click:function click(){$(this).dialog("close")}}],width:700,height:300});if(!alarmDialog.dialog("isOpen")){alarmDialog.dialog("open")}this.playSound(data.sound);this.modifyWindow()};this.getAlarms=function(){if(xalarm.gettingAlarms||$("html.iframe").length){return}xalarm.gettingAlarms=true;$.ajax({url:rcmail.url("xcalendarGetAlarms"),method:"POST",headers:{"x-csrf-token":rcmail.env.request_token},data:{}}).done(function(response){try{response=JSON.parse(response);if(response.list!==undefined&&response.list){xalarm.show(response)}}catch(e){}xalarm.gettingAlarms=false})};this.snooze=function(minutes,id){$.ajax({url:rcmail.url("xcalendarSnooze"),method:"POST",headers:{"x-csrf-token":rcmail.env.request_token},data:{alarmId:id,snooze:minutes}}).done(function(response){try{xalarm.dismiss(id)}catch(e){}})};this.dismiss=function(id){$("#xevent-alarm-"+id).remove();if(!$("#xcalendar-alarm-dialog .xevent-alarm").length){$("#xcalendar-alarm-dialog").dialog("close")}};this.playSound=function(sound){if(!sound){return}var url=rcmail.assets_path("plugins/xcalendar/assets/sounds/"+sound);var sounds=[url+".ogg",url+".acc",url+".mp3"];if(xframework.isCpanel()){sounds=(_readOnlyError("sounds"),[url+".wav",url+".ogg",url+".acc",url+".mp3"])}var howl=new Howl({src:sounds});howl.play()};this.previewSound=function(){this.playSound($("#xcalendar_alarm_sound").val())};this.modifyWindow=function(){if(!this.flashInterval){this.originalFavicon=$("link[rel='shortcut icon']").attr("href");this.flashInterval=setInterval(function(){xalarm.flashFavicon()},1e3)}try{if(window.external.msIsSiteMode()){window.external.msSiteModeActivate()}}catch(e){}};this.restoreWindow=function(){if(this.flashInterval){var win=rcmail.is_framed()?window.parent:window;$("link[rel='shortcut icon']",win.document).attr("href",this.originalFavicon);clearInterval(this.flashInterval);this.flashInterval=false}};this.flashFavicon=function(){var link=$("link[rel='shortcut icon']");var alarmFavicon=rcmail.assets_path("plugins/xcalendar/assets/images/alarm-favicon.ico");link.attr("href",link.attr("href")===alarmFavicon?this.originalFavicon:alarmFavicon)}};